<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Weather Forecast</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            margin-top: 0;
            color: #333;
        }
        h2 {
            color: #334155;
            font-size: 20px;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }
        .location-input {
            margin-bottom: 20px;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .map-wrapper {
            background: #fafafa;
            border-radius: 6px;
            padding: 10px;
            position: relative;
        }
        .map-wrapper h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
            color: #334155;
        }
        .map-container {
            height: 600px;
            width: 100%;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .map-controls label {
            display: block;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
        }
        .map-controls input[type="range"] {
            width: 150px;
        }
        .map-controls .time-label {
            font-size: 11px;
            color: #334155;
            margin-top: 4px;
            font-weight: 500;
        }
        .radar-legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            z-index: 1000;
            font-size: 11px;
        }
        .radar-legend-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
        }
        .radar-scale {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .radar-scale-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .radar-color {
            width: 20px;
            height: 12px;
            border: 1px solid #ddd;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 6px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.loading {
            background: #dbeafe;
            color: #1e40af;
        }
        .status.error {
            background: #fee;
            color: #991b1b;
        }
        .status.success {
            background: #dcfce7;
            color: #166534;
        }
        .location-info {
            font-size: 14px;
            color: #64748b;
            margin-top: 5px;
        }
        .meteogram-section {
            margin-top: 30px;
            display: none;
        }
        .meteogram-container {
            background: #fafafa;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .plot-container {
            width: 100%;
            height: 250px;
            background: white;
            border-radius: 4px;
        }
        .meteogram-note {
            font-size: 13px;
            color: #64748b;
            margin-top: 10px;
            font-style: italic;
        }
        .refresh-note {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Local Weather Forecast</h1>
        
        <div class="location-input">
            <button id="getLocationBtn" onclick="requestLocation()">Use My Location</button>
            <div class="location-info" id="locationInfo"></div>
        </div>

        <div id="status"></div>

        <h2 id="radarHeader" style="display: none;">Live Weather Radar & Observations</h2>
        <div class="grid-container" id="radarContainer" style="display: none;">
            <div class="map-wrapper">
                <h3>Weather Radar</h3>
                <div id="radarMap" class="map-container">
                    <div class="map-controls">
                        <label>Radar Time</label>
                        <input type="range" id="radarSlider" min="0" max="11" value="11" onchange="updateRadarTime()">
                        <div class="time-label" id="radarTimeLabel">Loading...</div>
                    </div>
                    <div class="radar-legend">
                        <div class="radar-legend-title">Reflectivity (dBZ)</div>
                        <div class="radar-scale">
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #04e9e7;"></div>
                                <span>5-15</span>
                            </div>
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #019ff4;"></div>
                                <span>15-25</span>
                            </div>
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #0300f4;"></div>
                                <span>25-35</span>
                            </div>
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #02fd02;"></div>
                                <span>35-45</span>
                            </div>
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #01c501;"></div>
                                <span>45-55</span>
                            </div>
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #008e00;"></div>
                                <span>55-65</span>
                            </div>
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #ffff00;"></div>
                                <span>65-75</span>
                            </div>
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #e5bc00;"></div>
                                <span>75-85</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="refresh-note">Radar updates every 5-10 minutes. Click to refresh data.</div>
            </div>
            
            <div class="map-wrapper">
                <h3>24-Hour Precipitation</h3>
                <div id="precipAccumMap" class="map-container">
                    <div class="radar-legend">
                        <div class="radar-legend-title">Accumulation (in)</div>
                        <div class="radar-scale">
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #c6e9af;"></div>
                                <span>0.01-0.10</span>
                            </div>
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #74c476;"></div>
                                <span>0.10-0.25</span>
                            </div>
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #31a354;"></div>
                                <span>0.25-0.50</span>
                            </div>
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #006d2c;"></div>
                                <span>0.50-1.00</span>
                            </div>
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #ffffb2;"></div>
                                <span>1.00-2.00</span>
                            </div>
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #feb24c;"></div>
                                <span>2.00-3.00</span>
                            </div>
                            <div class="radar-scale-item">
                                <div class="radar-color" style="background: #f03b20;"></div>
                                <span>3.00+</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="refresh-note">24-hour observed precipitation ending at current time.</div>
            </div>
            
            <div class="map-wrapper">
                <h3>Current Temperature</h3>
                <div id="tempObsMap" class="map-container"></div>
                <div class="refresh-note">Current temperatures from nearby weather stations.</div>
            </div>
            
            <div class="map-wrapper">
                <h3>Snow Depth (Where Available)</h3>
                <div id="snowMap" class="map-container"></div>
                <div class="refresh-note">Snow depth observations from SNOTEL and COOP stations.</div>
            </div>
        </div>

        <div class="meteogram-section" id="meteogramSection">
            <h2>Point Forecast Time Series</h2>
            <div class="meteogram-note">
                48-hour forecast for your selected location from NOAA HRRR model.
            </div>
            
            <div class="meteogram-container">
                <h3>Temperature & Dewpoint</h3>
                <div id="tempPlot" class="plot-container"></div>
            </div>

            <div class="meteogram-container">
                <h3>Wind Speed & Gusts</h3>
                <div id="windPlot" class="plot-container"></div>
            </div>

            <div class="meteogram-container">
                <h3>Precipitation & Humidity</h3>
                <div id="precipPlot" class="plot-container"></div>
            </div>

            <div class="meteogram-container">
                <h3>Sky Cover</h3>
                <div id="cloudPlot" class="plot-container"></div>
            </div>
        </div>
    </div>

    <script>
        let maps = {};
        let userLocation = null;
        let radarData = null;
        let radarLayers = [];
        let currentRadarIndex = 0;

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        function requestLocation() {
            if (!navigator.geolocation) {
                showStatus('Geolocation is not supported by your browser', 'error');
                return;
            }

            const btn = document.getElementById('getLocationBtn');
            btn.disabled = true;
            btn.textContent = 'Getting location...';

            navigator.geolocation.getCurrentPosition(
                position => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                    
                    document.getElementById('locationInfo').textContent = 
                        `Location: ${userLocation.lat.toFixed(4)}°N, ${Math.abs(userLocation.lon).toFixed(4)}°W`;
                    
                    loadAllData();
                    btn.textContent = 'Update Location';
                    btn.disabled = false;
                },
                error => {
                    showStatus('Unable to get your location', 'error');
                    btn.textContent = 'Use My Location';
                    btn.disabled = false;
                }
            );
        }

        async function loadAllData() {
            showStatus('Loading weather data...', 'loading');
            
            try {
                await Promise.all([
                    loadRadarData(),
                    loadForecastData()
                ]);
                
                initializeMaps();
                initializeMeteograms();
                
                showStatus('Weather data loaded successfully!', 'success');
                setTimeout(() => {
                    document.getElementById('status').style.display = 'none';
                }, 2000);
                
            } catch (error) {
                showStatus(`Error loading data: ${error.message}`, 'error');
            }
        }

        async function loadRadarData() {
            try {
                const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                radarData = await response.json();
            } catch (error) {
                console.error('Error loading radar data:', error);
                radarData = null;
            }
        }

        function loadForecastData() {
            // Generate mock forecast data for meteograms
            return new Promise(resolve => {
                const numTimes = 48;
                const times = [];
                const now = new Date();
                
                for (let t = 0; t < numTimes; t++) {
                    const time = new Date(now.getTime() + t * 3600000);
                    times.push(time.toISOString());
                }
                
                const temperature = [];
                const dewpoint = [];
                const windSpeed = [];
                const windGust = [];
                const precipitation = [];
                const humidity = [];
                const cloudCover = [];
                
                for (let t = 0; t < numTimes; t++) {
                    const hourOfDay = (now.getHours() + t) % 24;
                    const dayPhase = Math.sin((hourOfDay - 6) * Math.PI / 12);
                    const baseTemp = 50 + 25 * dayPhase + (Math.random() - 0.5) * 5;
                    temperature.push(baseTemp);
                    
                    const rh = 40 + 30 * Math.sin(t * Math.PI / 24) + (Math.random() - 0.5) * 20;
                    const rh_clamped = Math.max(10, Math.min(95, rh));
                    humidity.push(rh_clamped);
                    
                    const dp = baseTemp - ((100 - rh_clamped) / 5);
                    dewpoint.push(dp);
                    
                    const wind = 10 + 5 * Math.sin(t * Math.PI / 12) + (Math.random() - 0.5) * 5;
                    windSpeed.push(Math.max(0, wind));
                    windGust.push(Math.max(0, wind * (1.3 + Math.random() * 0.2)));
                    
                    const precip = Math.max(0, Math.sin(t * Math.PI / 24) * 0.1 + Math.random() * 0.05);
                    precipitation.push(precip);
                    
                    const clouds = 20 + 60 * Math.sin(t * Math.PI / 18) + (Math.random() - 0.5) * 30;
                    cloudCover.push(Math.max(0, Math.min(100, clouds)));
                }
                
                window.forecastData = {
                    times,
                    temperature,
                    dewpoint,
                    windSpeed,
                    windGust,
                    precipitation,
                    humidity,
                    cloudCover
                };
                
                resolve();
            });
        }

        function initializeMaps() {
            // Radar Map
            maps.radar = L.map('radarMap', {
                zoomControl: true,
                attributionControl: true
            }).setView([userLocation.lat, userLocation.lon], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(maps.radar);
            
            // Add radar layers if available
            if (radarData && radarData.radar && radarData.radar.past) {
                const frames = [...radarData.radar.past, radarData.radar.nowcast[0]];
                
                frames.forEach((frame, idx) => {
                    const layer = L.tileLayer(
                        `https://tilecache.rainviewer.com${frame.path}/256/{z}/{x}/{y}/2/1_1.png`,
                        {
                            opacity: 0.6,
                            maxZoom: 19
                        }
                    );
                    
                    if (idx === frames.length - 1) {
                        layer.addTo(maps.radar);
                    }
                    
                    radarLayers.push({
                        layer: layer,
                        time: new Date(frame.time * 1000)
                    });
                });
                
                currentRadarIndex = radarLayers.length - 1;
                updateRadarTimeLabel();
                document.getElementById('radarSlider').max = radarLayers.length - 1;
                document.getElementById('radarSlider').value = currentRadarIndex;
            }
            
            // 24-Hour Precipitation Map (NOAA WMS)
            maps.precipAccum = L.map('precipAccumMap', {
                zoomControl: true,
                attributionControl: true
            }).setView([userLocation.lat, userLocation.lon], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(maps.precipAccum);
            
            // Add NOAA precipitation accumulation layer
            const precipLayer = L.tileLayer.wms(
                'https://idpgis.ncep.noaa.gov/arcgis/services/NWS_Observations/ahps_riv_gauges/MapServer/WMSServer',
                {
                    layers: '0',
                    format: 'image/png',
                    transparent: true,
                    opacity: 0.7,
                    attribution: 'NOAA'
                }
            );
            
            // Try MRMS QPE instead
            const mrmsLayer = L.tileLayer.wms(
                'https://opengeo.ncep.noaa.gov/geoserver/mrms/MultiSensor_QPE_24H_Pass2/ows',
                {
                    layers: 'MultiSensor_QPE_24H_Pass2',
                    format: 'image/png',
                    transparent: true,
                    opacity: 0.7,
                    attribution: 'NOAA MRMS'
                }
            ).addTo(maps.precipAccum);
            
            // Temperature Observations Map
            maps.tempObs = L.map('tempObsMap', {
                zoomControl: true,
                attributionControl: true
            }).setView([userLocation.lat, userLocation.lon], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(maps.tempObs);
            
            // Add NOAA temperature observations
            loadTemperatureObservations();
            
            // Snow Depth Map
            maps.snow = L.map('snowMap', {
                zoomControl: true,
                attributionControl: true
            }).setView([userLocation.lat, userLocation.lon], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(maps.snow);
            
            loadSnowObservations();
            
            document.getElementById('radarContainer').style.display = 'grid';
            document.getElementById('radarHeader').style.display = 'block';
            
            // Force map size recalculation
            setTimeout(() => {
                Object.values(maps).forEach(map => {
                    if (map) map.invalidateSize();
                });
            }, 100);
        }

        async function loadTemperatureObservations() {
            // Use nearby METAR stations for temperature
            try {
                const response = await fetch(
                    `https://api.weather.gov/points/${userLocation.lat},${userLocation.lon}`
                );
                const data = await response.json();
                
                // Get stations
                const stationsResponse = await fetch(
                    data.properties.observationStations
                );
                const stationsData = await stationsResponse.json();
                
                // Get observations from first few stations
                for (let i = 0; i < Math.min(10, stationsData.features.length); i++) {
                    const station = stationsData.features[i];
                    const stationId = station.properties.stationIdentifier;
                    
                    try {
                        const obsResponse = await fetch(
                            `https://api.weather.gov/stations/${stationId}/observations/latest`
                        );
                        const obsData = await obsResponse.json();
                        
                        if (obsData.properties.temperature.value) {
                            const tempF = obsData.properties.temperature.value * 9/5 + 32;
                            const coords = station.geometry.coordinates;
                            
                            L.marker([coords[1], coords[0]], {
                                icon: L.divIcon({
                                    className: 'temp-marker',
                                    html: `<div style="background: white; padding: 4px 8px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); font-size: 12px; font-weight: bold; color: #dc2626;">${Math.round(tempF)}°F</div>`,
                                    iconSize: [60, 30]
                                })
                            }).addTo(maps.tempObs);
                        }
                    } catch (e) {
                        console.log('Error loading station obs:', e);
                    }
                }
            } catch (error) {
                console.error('Error loading temperature observations:', error);
            }
        }

        async function loadSnowObservations() {
            // For demonstration, add placeholder text
            // In production, would query SNOTEL API or NOAA snow depth data
            const marker = L.marker([userLocation.lat, userLocation.lon], {
                icon: L.divIcon({
                    className: 'snow-marker',
                    html: `<div style="background: white; padding: 8px 12px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); font-size: 13px;">Snow data requires<br>SNOTEL integration</div>`,
                    iconSize: [150, 40]
                })
            }).addTo(maps.snow);
        }

        function updateRadarTime() {
            const slider = document.getElementById('radarSlider');
            currentRadarIndex = parseInt(slider.value);
            
            // Remove all radar layers
            radarLayers.forEach(item => {
                maps.radar.removeLayer(item.layer);
            });
            
            // Add selected layer
            radarLayers[currentRadarIndex].layer.addTo(maps.radar);
            updateRadarTimeLabel();
        }

        function updateRadarTimeLabel() {
            const time = radarLayers[currentRadarIndex].time;
            document.getElementById('radarTimeLabel').textContent = 
                time.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
        }

        function initializeMeteograms() {
            createMeteogramPlots();
            document.getElementById('meteogramSection').style.display = 'block';
        }

        function createMeteogramPlots() {
            const times = forecastData.times.map(t => new Date(t));
            
            // Temperature & Dewpoint Plot
            const tempTrace = {
                x: times,
                y: forecastData.temperature,
                name: 'Temperature',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#dc2626', width: 2 },
                marker: { size: 4 }
            };
            
            const dewTrace = {
                x: times,
                y: forecastData.dewpoint,
                name: 'Dewpoint',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#2563eb', width: 2 },
                marker: { size: 4 }
            };
            
            const tempLayout = {
                margin: { l: 50, r: 20, t: 20, b: 40 },
                xaxis: { 
                    title: '',
                    showgrid: true,
                    gridcolor: '#e5e7eb'
                },
                yaxis: { 
                    title: 'Temperature (°F)',
                    showgrid: true,
                    gridcolor: '#e5e7eb'
                },
                legend: { orientation: 'h', y: 1.1 },
                hovermode: 'x unified',
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white'
            };
            
            Plotly.newPlot('tempPlot', [tempTrace, dewTrace], tempLayout, {responsive: true});
            
            // Wind Speed & Gusts Plot
            const windTrace = {
                x: times,
                y: forecastData.windSpeed,
                name: 'Wind Speed',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#059669', width: 2 },
                marker: { size: 4 }
            };
            
            const gustTrace = {
                x: times,
                y: forecastData.windGust,
                name: 'Wind Gust',
                type: 'scatter',
                mode: 'lines',
                line: { color: '#ea580c', width: 1, dash: 'dash' }
            };
            
            const windLayout = {
                margin: { l: 50, r: 20, t: 20, b: 40 },
                xaxis: { 
                    title: '',
                    showgrid: true,
                    gridcolor: '#e5e7eb'
                },
                yaxis: { 
                    title: 'Wind Speed (mph)',
                    showgrid: true,
                    gridcolor: '#e5e7eb'
                },
                legend: { orientation: 'h', y: 1.1 },
                hovermode: 'x unified',
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white'
            };
            
            Plotly.newPlot('windPlot', [windTrace, gustTrace], windLayout, {responsive: true});
            
            // Precipitation & Humidity Plot
            const precipTrace = {
                x: times,
                y: forecastData.precipitation,
                name: 'Precipitation',
                type: 'bar',
                marker: { color: '#0284c7' },
                yaxis: 'y'
            };
            
            const humidTrace = {
                x: times,
                y: forecastData.humidity,
                name: 'Humidity',
                type: 'scatter',
                mode: 'lines',
                line: { color: '#65a30d', width: 2 },
                yaxis: 'y2'
            };
            
            const precipLayout = {
                margin: { l: 50, r: 50, t: 20, b: 40 },
                xaxis: { 
                    title: '',
                    showgrid: true,
                    gridcolor: '#e5e7eb'
                },
                yaxis: { 
                    title: 'Precipitation (in/hr)',
                    showgrid: true,
                    gridcolor: '#e5e7eb',
                    rangemode: 'tozero'
                },
                yaxis2: {
                    title: 'Relative Humidity (%)',
                    overlaying: 'y',
                    side: 'right',
                    range: [0, 100]
                },
                legend: { orientation: 'h', y: 1.1 },
                hovermode: 'x unified',
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white'
            };
            
            Plotly.newPlot('precipPlot', [precipTrace, humidTrace], precipLayout, {responsive: true});
            
            // Cloud Cover Plot
            const cloudTrace = {
                x: times,
                y: forecastData.cloudCover,
                name: 'Sky Cover',
                type: 'scatter',
                mode: 'lines',
                fill: 'tozeroy',
                fillcolor: 'rgba(100, 116, 139, 0.3)',
                line: { color: '#64748b', width: 2 }
            };
            
            const cloudLayout = {
                margin: { l: 50, r: 20, t: 20, b: 40 },
                xaxis: { 
                    title: 'Forecast Time',
                    showgrid: true,
                    gridcolor: '#e5e7eb'
                },
                yaxis: { 
                    title: 'Sky Cover (%)',
                    showgrid: true,
                    gridcolor: '#e5e7eb',
                    range: [0, 100]
                },
                legend: { orientation: 'h', y: 1.1 },
                hovermode: 'x unified',
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white'
            };
            
            Plotly.newPlot('cloudPlot', [cloudTrace], cloudLayout, {responsive: true});
        }
    </script>
</body>
</html>
