<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Resources Dashboard Demo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .map-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .map-header h2 {
            font-size: 20px;
            color: #1e40af;
        }
        
        .location-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #1d4ed8;
        }
        
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        
        .map-container {
            height: 700px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            position: relative;
        }
        
        .layer-control {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            max-width: 300px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .layer-control h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #1e40af;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
        }
        
        .layer-category {
            margin-bottom: 15px;
        }
        
        .layer-category-title {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .layer-item input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .layer-item label {
            cursor: pointer;
            flex: 1;
        }
        
        .opacity-control {
            display: flex;
            align-items: center;
            margin-top: 4px;
            margin-left: 24px;
            font-size: 11px;
            color: #64748b;
        }
        
        .opacity-control input[type="range"] {
            width: 100px;
            margin-left: 8px;
        }
        
        .location-info {
            font-size: 13px;
            color: #64748b;
            margin-left: 10px;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 12px;
            max-width: 250px;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1e40af;
            font-size: 13px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .legend-color {
            width: 20px;
            height: 14px;
            margin-right: 6px;
            border: 1px solid #ddd;
            border-radius: 2px;
        }
        
        .status {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .status.loading {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status.error {
            background: #fee;
            color: #991b1b;
        }
        
        .status.success {
            background: #dcfce7;
            color: #166534;
        }
        
        .meteogram-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }
        
        .meteogram-section h2 {
            font-size: 20px;
            color: #1e40af;
            margin-bottom: 15px;
        }
        
        .plot-container {
            width: 100%;
            height: 250px;
            margin-bottom: 20px;
        }
        
        .radar-controls {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .radar-controls label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #334155;
            margin-bottom: 6px;
        }
        
        .radar-controls input[type="range"] {
            width: 100%;
        }
        
        .radar-time-display {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Intermountain Water Resources Dashboard</h1>
        <p>Real-time snow, precipitation, drought, and streamflow conditions for Colorado and surrounding regions</p>
    </div>
    
    <div class="container">
        <div class="map-section">
            <div class="map-header">
                <h2>Interactive Water Resources Map</h2>
                <div class="location-controls">
                    <button id="getLocationBtn" onclick="requestLocation()">Use My Location</button>
                    <button onclick="resetView()">Reset View</button>
                    <span class="location-info" id="locationInfo"></span>
                </div>
            </div>
            
            <div id="status"></div>
            
            <div class="radar-controls" id="radarControls" style="display: none;">
                <label>Weather Radar Time</label>
                <input type="range" id="radarSlider" min="0" max="11" value="11" onchange="updateRadarTime()">
                <div class="radar-time-display" id="radarTimeDisplay">Current</div>
            </div>
            
            <div class="map-container" id="mainMap">
                <div class="layer-control">
                    <h3>Data Layers</h3>
                    
                    <div class="layer-category">
                        <div class="layer-category-title">Weather Radar</div>
                        <div class="layer-item">
                            <input type="checkbox" id="layer-radar" onchange="toggleLayer('radar')">
                            <label for="layer-radar">Live Radar (RainViewer)</label>
                        </div>
                        <div class="opacity-control">
                            <span>Opacity:</span>
                            <input type="range" min="0" max="100" value="60" onchange="setLayerOpacity('radar', this.value)">
                        </div>
                    </div>
                    
                    <div class="layer-category">
                        <div class="layer-category-title">Snow Analysis</div>
                        <div class="layer-item">
                            <input type="checkbox" id="layer-swe" onchange="toggleLayer('swe')">
                            <label for="layer-swe">Snow Water Equivalent (NOHRSC)</label>
                        </div>
                        <div class="opacity-control">
                            <span>Opacity:</span>
                            <input type="range" min="0" max="100" value="70" onchange="setLayerOpacity('swe', this.value)">
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="layer-snowdepth" onchange="toggleLayer('snowdepth')">
                            <label for="layer-snowdepth">Snow Depth (NOHRSC)</label>
                        </div>
                        <div class="opacity-control">
                            <span>Opacity:</span>
                            <input type="range" min="0" max="100" value="70" onchange="setLayerOpacity('snowdepth', this.value)">
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="layer-snotel" onchange="toggleLayer('snotel')">
                            <label for="layer-snotel">SNOTEL Stations</label>
                        </div>
                    </div>
                    
                    <div class="layer-category">
                        <div class="layer-category-title">Precipitation</div>
                        <div class="layer-item">
                            <input type="checkbox" id="layer-precip24" onchange="toggleLayer('precip24')">
                            <label for="layer-precip24">24-Hour QPE (MRMS)</label>
                        </div>
                        <div class="opacity-control">
                            <span>Opacity:</span>
                            <input type="range" min="0" max="100" value="70" onchange="setLayerOpacity('precip24', this.value)">
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="layer-precip7" onchange="toggleLayer('precip7')">
                            <label for="layer-precip7">7-Day Snowfall (NOHRSC)</label>
                        </div>
                        <div class="opacity-control">
                            <span>Opacity:</span>
                            <input type="range" min="0" max="100" value="70" onchange="setLayerOpacity('precip7', this.value)">
                        </div>
                    </div>
                    
                    <div class="layer-category">
                        <div class="layer-category-title">Drought</div>
                        <div class="layer-item">
                            <input type="checkbox" id="layer-drought" onchange="toggleLayer('drought')">
                            <label for="layer-drought">US Drought Monitor</label>
                        </div>
                        <div class="opacity-control">
                            <span>Opacity:</span>
                            <input type="range" min="0" max="100" value="60" onchange="setLayerOpacity('drought', this.value)">
                        </div>
                    </div>
                    
                    <div class="layer-category">
                        <div class="layer-category-title">Streamflow</div>
                        <div class="layer-item">
                            <input type="checkbox" id="layer-streamflow" onchange="toggleLayer('streamflow')">
                            <label for="layer-streamflow">Current Conditions (CDSS)</label>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="layer-reservoirs" onchange="toggleLayer('reservoirs')">
                            <label for="layer-reservoirs">Reservoir Storage (CDSS)</label>
                        </div>
                    </div>
                    
                    <div class="layer-category">
                        <div class="layer-category-title">Base Maps</div>
                        <div class="layer-item">
                            <input type="radio" name="basemap" id="basemap-osm" checked onchange="changeBasemap('osm')">
                            <label for="basemap-osm">Street Map</label>
                        </div>
                        <div class="layer-item">
                            <input type="radio" name="basemap" id="basemap-topo" onchange="changeBasemap('topo')">
                            <label for="basemap-topo">Topographic</label>
                        </div>
                        <div class="layer-item">
                            <input type="radio" name="basemap" id="basemap-satellite" onchange="changeBasemap('satellite')">
                            <label for="basemap-satellite">Satellite</label>
                        </div>
                    </div>
                </div>
                
                <div class="legend" id="activeLegend" style="display: none;">
                    <div class="legend-title" id="legendTitle">Snow Water Equivalent</div>
                    <div id="legendContent"></div>
                </div>
            </div>
        </div>
        
        <div class="meteogram-section" id="meteogramSection" style="display: none;">
            <h2>48-Hour Forecast</h2>
            <div class="plot-container" id="tempPlot"></div>
            <div class="plot-container" id="windPlot"></div>
            <div class="plot-container" id="precipPlot"></div>
        </div>
    </div>

    <script>
        let map;
        let userLocation = { lat: 39.7392, lon: -104.9903 }; // Denver default
        let layers = {};
        let radarData = null;
        let radarLayers = [];
        let currentRadarIndex = 0;
        let basemaps = {};
        let currentBasemap = 'osm';

        // Initialize map
        function initMap() {
            map = L.map('mainMap', {
                center: [userLocation.lat, userLocation.lon],
                zoom: 7,
                zoomControl: true
            });
            
            // Setup basemaps
            basemaps.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            basemaps.topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenTopoMap contributors',
                maxZoom: 17
            });
            
            basemaps.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri',
                maxZoom: 19
            });
            
            // Initialize all data layers
            initializeLayers();
            
            // Load radar data
            loadRadarData();
        }

        function initializeLayers() {
            // NOHRSC Snow Water Equivalent (proper endpoint)
            layers.swe = L.tileLayer.wms(
                'https://id pgis.ncep.noaa.gov/arcgis/services/NWS_Observations/NOHRSC_Snow_Analysis/MapServer/WMSServer',
                {
                    layers: '3',
                    format: 'image/png',
                    transparent: true,
                    opacity: 0.7,
                    attribution: 'NOAA NOHRSC',
                    version: '1.3.0'
                }
            );
            
            // NOHRSC Snow Depth
            layers.snowdepth = L.tileLayer.wms(
                'https://idpgis.ncep.noaa.gov/arcgis/services/NWS_Observations/NOHRSC_Snow_Analysis/MapServer/WMSServer',
                {
                    layers: '1',
                    format: 'image/png',
                    transparent: true,
                    opacity: 0.7,
                    attribution: 'NOAA NOHRSC',
                    version: '1.3.0'
                }
            );
            
            // NOHRSC 24-Hour QPE (Quantitative Precipitation Estimate)
            layers.precip24 = L.tileLayer.wms(
                'https://idpgis.ncep.noaa.gov/arcgis/services/NWS_Observations/rfc_qpe/MapServer/WMSServer',
                {
                    layers: '0',
                    format: 'image/png',
                    transparent: true,
                    opacity: 0.7,
                    attribution: 'NOAA',
                    version: '1.3.0'
                }
            );
            
            // NOHRSC 7-day snowfall
            layers.precip7 = L.tileLayer.wms(
                'https://idpgis.ncep.noaa.gov/arcgis/services/NWS_Observations/NOHRSC_Snowfall_Analysis/MapServer/WMSServer',
                {
                    layers: '2',
                    format: 'image/png',
                    transparent: true,
                    opacity: 0.7,
                    attribution: 'NOAA NOHRSC',
                    version: '1.3.0'
                }
            );
            
            // US Drought Monitor
            layers.drought = L.tileLayer.wms(
                'https://ndmc-001.unl.edu:8080/cgi-bin/mapserv.exe?map=/ms4w/apps/usdm/service/usdm_current_wms.map',
                {
                    layers: 'usdm_current',
                    format: 'image/png',
                    transparent: true,
                    opacity: 0.6,
                    attribution: 'US Drought Monitor',
                    version: '1.3.0'
                }
            );
            
            // Initialize layer groups for point data
            layers.streamflow = L.layerGroup();
            layers.snotel = L.layerGroup();
            layers.radar = L.layerGroup();
            layers.reservoirs = L.layerGroup();
        }

        async function loadRadarData() {
            try {
                const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                radarData = await response.json();
                
                if (radarData && radarData.radar && radarData.radar.past) {
                    const frames = [...radarData.radar.past, radarData.radar.nowcast[0]];
                    
                    radarLayers = frames.map(frame => ({
                        layer: L.tileLayer(
                            `https://tilecache.rainviewer.com${frame.path}/256/{z}/{x}/{y}/2/1_1.png`,
                            {
                                opacity: 0.6,
                                maxZoom: 19
                            }
                        ),
                        time: new Date(frame.time * 1000)
                    }));
                    
                    currentRadarIndex = radarLayers.length - 1;
                    document.getElementById('radarSlider').max = radarLayers.length - 1;
                    document.getElementById('radarSlider').value = currentRadarIndex;
                    document.getElementById('radarControls').style.display = 'block';
                    updateRadarTimeDisplay();
                }
            } catch (error) {
                console.error('Error loading radar data:', error);
            }
        }

        function toggleLayer(layerName) {
            const checkbox = document.getElementById(`layer-${layerName}`);
            
            if (checkbox.checked) {
                if (layerName === 'radar' && radarLayers.length > 0) {
                    radarLayers[currentRadarIndex].layer.addTo(map);
                    layers.radar = radarLayers[currentRadarIndex].layer;
                    updateLegend('radar');
                } else if (layerName === 'streamflow') {
                    loadStreamflowData();
                    layers.streamflow.addTo(map);
                } else if (layerName === 'reservoirs') {
                    loadReservoirData();
                    layers.reservoirs.addTo(map);
                } else if (layerName === 'snotel') {
                    loadSnotelData();
                    layers.snotel.addTo(map);
                } else if (layers[layerName]) {
                    layers[layerName].addTo(map);
                    updateLegend(layerName);
                }
            } else {
                if (layerName === 'radar' && radarLayers.length > 0) {
                    radarLayers[currentRadarIndex].layer.remove();
                } else if (layers[layerName]) {
                    layers[layerName].remove();
                }
                hideLegend();
            }
        }

        function setLayerOpacity(layerName, value) {
            const opacity = value / 100;
            if (layerName === 'radar' && radarLayers.length > 0) {
                radarLayers[currentRadarIndex].layer.setOpacity(opacity);
            } else if (layers[layerName] && layers[layerName].setOpacity) {
                layers[layerName].setOpacity(opacity);
            }
        }

        function updateRadarTime() {
            const slider = document.getElementById('radarSlider');
            const newIndex = parseInt(slider.value);
            
            if (radarLayers.length > 0) {
                // Remove old layer
                if (map.hasLayer(radarLayers[currentRadarIndex].layer)) {
                    map.removeLayer(radarLayers[currentRadarIndex].layer);
                    radarLayers[newIndex].layer.addTo(map);
                }
                currentRadarIndex = newIndex;
                updateRadarTimeDisplay();
            }
        }

        function updateRadarTimeDisplay() {
            if (radarLayers.length > 0) {
                const time = radarLayers[currentRadarIndex].time;
                document.getElementById('radarTimeDisplay').textContent = 
                    time.toLocaleString('en-US', { 
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric', 
                        minute: '2-digit' 
                    });
            }
        }

        async function loadStreamflowData() {
            // Load streamflow data from Colorado CDSS REST API
            try {
                showStatus('Loading Colorado streamflow stations...', 'loading');
                
                const response = await fetch(
                    'https://dwr.state.co.us/Rest/GET/api/v2/telemetrystations/telemetrystation?' +
                    'format=json&abbrev=*&includeThirdParty=true'
                );
                
                if (!response.ok) {
                    console.error('CDSS API error:', response.status);
                    return;
                }
                
                const data = await response.json();
                layers.streamflow.clearLayers();
                
                if (data.ResultList && data.ResultList.length > 0) {
                    // Filter for stations near user location and active streamflow stations
                    const nearbyStations = data.ResultList.filter(station => {
                        const lat = station.latitude;
                        const lon = station.longitude;
                        const distance = Math.sqrt(
                            Math.pow(lat - userLocation.lat, 2) + 
                            Math.pow(lon - userLocation.lon, 2)
                        );
                        return distance < 3 && station.stationStatus === 'Active'; // Within ~3 degrees
                    }).slice(0, 50); // Limit to 50 stations
                    
                    for (const station of nearbyStations) {
                        try {
                            // Get latest streamflow data for this station
                            const tsResponse = await fetch(
                                `https://dwr.state.co.us/Rest/GET/api/v2/telemetrystations/telemetrytimeseriesraw/` +
                                `?format=json&abbrev=${station.abbrev}&parameter=DISCHRG`
                            );
                            
                            if (tsResponse.ok) {
                                const tsData = await tsResponse.json();
                                if (tsData.ResultList && tsData.ResultList.length > 0) {
                                    const latest = tsData.ResultList[tsData.ResultList.length - 1];
                                    const flow = latest.measValue;
                                    
                                    // Color based on flow magnitude
                                    let color = '#2563eb';
                                    if (flow > 1000) color = '#dc2626';
                                    else if (flow > 100) color = '#f59e0b';
                                    
                                    const marker = L.circleMarker([station.latitude, station.longitude], {
                                        radius: 6,
                                        fillColor: color,
                                        color: 'white',
                                        weight: 2,
                                        opacity: 1,
                                        fillOpacity: 0.8
                                    }).bindPopup(
                                        `<strong>${station.stationName}</strong><br>` +
                                        `Flow: ${flow} cfs<br>` +
                                        `Updated: ${new Date(latest.measDate).toLocaleString()}`
                                    );
                                    
                                    layers.streamflow.addLayer(marker);
                                }
                            }
                        } catch (e) {
                            console.log('Error loading station data:', station.abbrev);
                        }
                    }
                    
                    showStatus(`Loaded ${nearbyStations.length} streamflow stations`, 'success');
                }
            } catch (error) {
                console.error('Error loading CDSS streamflow data:', error);
                showStatus('Error loading streamflow data', 'error');
            }
        }

        async function loadReservoirData() {
            // Load reservoir data from Colorado CDSS
            try {
                showStatus('Loading reservoir data...', 'loading');
                
                const response = await fetch(
                    'https://dwr.state.co.us/Rest/GET/api/v2/structures/divrec/divrecday?' +
                    'format=json&structureType=RESERVOIR'
                );
                
                if (!response.ok) {
                    console.error('CDSS reservoir API error:', response.status);
                    return;
                }
                
                const data = await response.json();
                layers.reservoirs.clearLayers();
                
                if (data.ResultList && data.ResultList.length > 0) {
                    // Get unique reservoirs and their latest data
                    const reservoirMap = new Map();
                    
                    data.ResultList.forEach(record => {
                        if (record.structureName && record.waterClassNum === 1) {
                            if (!reservoirMap.has(record.wdid) || 
                                new Date(record.dataMeasDate) > new Date(reservoirMap.get(record.wdid).dataMeasDate)) {
                                reservoirMap.set(record.wdid, record);
                            }
                        }
                    });
                    
                    // Place markers for reservoirs with location data
                    for (const record of reservoirMap.values()) {
                        if (record.latitude && record.longitude) {
                            const storage = record.dataValue || 0;
                            
                            // Size marker based on storage
                            let radius = 8;
                            if (storage > 100000) radius = 12;
                            else if (storage > 10000) radius = 10;
                            
                            const marker = L.circleMarker([record.latitude, record.longitude], {
                                radius: radius,
                                fillColor: '#0ea5e9',
                                color: 'white',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.7
                            }).bindPopup(
                                `<strong>${record.structureName}</strong><br>` +
                                `Storage: ${storage.toLocaleString()} AF<br>` +
                                `Updated: ${new Date(record.dataMeasDate).toLocaleDateString()}`
                            );
                            
                            layers.reservoirs.addLayer(marker);
                        }
                    }
                    
                    showStatus(`Loaded ${reservoirMap.size} reservoirs`, 'success');
                }
            } catch (error) {
                console.error('Error loading reservoir data:', error);
                showStatus('Error loading reservoir data', 'error');
            }
        }

        async function loadSnotelData() {
            // Load SNOTEL station data
            try {
                const response = await fetch(
                    'https://wcc.sc.egov.usda.gov/awdbRestApi/services/v1/stations?' +
                    'stationTriplets=*:CO:SNTL&activeOnly=true&returnFields=stationId,name,latitude,longitude'
                );
                
                if (!response.ok) return;
                
                const stations = await response.json();
                layers.snotel.clearLayers();
                
                for (const station of stations.slice(0, 50)) {
                    try {
                        const sweResponse = await fetch(
                            `https://wcc.sc.egov.usda.gov/awdbRestApi/services/v1/data?` +
                            `stationTriplets=${station.stationId}:CO:SNTL&` +
                            `elementCd=WTEQ&duration=DAILY&getFlags=false&ordinal=1`
                        );
                        
                        if (sweResponse.ok) {
                            const sweData = await sweResponse.json();
                            if (sweData.length > 0 && sweData[0].values.length > 0) {
                                const latestSWE = sweData[0].values[sweData[0].values.length - 1].value;
                                
                                if (latestSWE > 0) {
                                    const marker = L.marker([station.latitude, station.longitude], {
                                        icon: L.divIcon({
                                            className: 'snotel-marker',
                                            html: `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 4px 8px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); font-size: 10px; font-weight: bold; color: white;">${latestSWE.toFixed(1)}"</div>`,
                                            iconSize: [40, 20]
                                        })
                                    }).bindPopup(`<strong>${station.name}</strong><br>SWE: ${latestSWE.toFixed(1)} inches`);
                                    
                                    layers.snotel.addLayer(marker);
                                }
                            }
                        }
                    } catch (e) {
                        console.log('Error loading station:', e);
                    }
                }
            } catch (error) {
                console.error('Error loading SNOTEL data:', error);
            }
        }

        function changeBasemap(type) {
            // Remove current basemap
            map.removeLayer(basemaps[currentBasemap]);
            // Add new basemap
            basemaps[type].addTo(map);
            currentBasemap = type;
            // Move to back
            basemaps[type].bringToBack();
        }

        function updateLegend(layerName) {
            const legend = document.getElementById('activeLegend');
            const title = document.getElementById('legendTitle');
            const content = document.getElementById('legendContent');
            
            const legends = {
                swe: {
                    title: 'Snow Water Equivalent (inches)',
                    items: [
                        { color: '#ffffff', label: '0' },
                        { color: '#b3e0ff', label: '0-5' },
                        { color: '#4da6ff', label: '5-10' },
                        { color: '#0066cc', label: '10-20' },
                        { color: '#003d7a', label: '20-40' },
                        { color: '#001a33', label: '40+' }
                    ]
                },
                snowdepth: {
                    title: 'Snow Depth (inches)',
                    items: [
                        { color: '#f0f0f0', label: '0-6' },
                        { color: '#d0e5f5', label: '6-12' },
                        { color: '#9ecae1', label: '12-24' },
                        { color: '#4292c6', label: '24-48' },
                        { color: '#084594', label: '48+' }
                    ]
                },
                drought: {
                    title: 'US Drought Monitor',
                    items: [
                        { color: '#ffff00', label: 'D0 - Abnormally Dry' },
                        { color: '#fcd37f', label: 'D1 - Moderate Drought' },
                        { color: '#ffaa00', label: 'D2 - Severe Drought' },
                        { color: '#e60000', label: 'D3 - Extreme Drought' },
                        { color: '#730000', label: 'D4 - Exceptional Drought' }
                    ]
                },
                radar: {
                    title: 'Radar Reflectivity (dBZ)',
                    items: [
                        { color: '#04e9e7', label: '5-15' },
                        { color: '#019ff4', label: '15-25' },
                        { color: '#0300f4', label: '25-35' },
                        { color: '#02fd02', label: '35-45' },
                        { color: '#01c501', label: '45-55' },
                        { color: '#ffff00', label: '65-75' }
                    ]
                }
            };
            
            if (legends[layerName]) {
                title.textContent = legends[layerName].title;
                content.innerHTML = legends[layerName].items.map(item => `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${item.color};"></div>
                        <span>${item.label}</span>
                    </div>
                `).join('');
                legend.style.display = 'block';
            }
        }

        function hideLegend() {
            const legend = document.getElementById('activeLegend');
            // Only hide if no layers are active
            const anyActive = ['swe', 'snowdepth', 'drought', 'radar'].some(layer => 
                document.getElementById(`layer-${layer}`).checked
            );
            if (!anyActive) {
                legend.style.display = 'none';
            }
        }

        function requestLocation() {
            if (!navigator.geolocation) {
                showStatus('Geolocation not supported', 'error');
                return;
            }

            const btn = document.getElementById('getLocationBtn');
            btn.disabled = true;
            btn.textContent = 'Getting location...';

            navigator.geolocation.getCurrentPosition(
                position => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                    
                    document.getElementById('locationInfo').textContent = 
                        `${userLocation.lat.toFixed(4)}°N, ${Math.abs(userLocation.lon).toFixed(4)}°W`;
                    
                    map.setView([userLocation.lat, userLocation.lon], 9);
                    loadForecastData();
                    
                    btn.textContent = 'Update Location';
                    btn.disabled = false;
                },
                error => {
                    showStatus('Unable to get location', 'error');
                    btn.textContent = 'Use My Location';
                    btn.disabled = false;
                }
            );
        }

        function resetView() {
            map.setView([userLocation.lat, userLocation.lon], 7);
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        async function loadForecastData() {
            // Generate mock forecast data
            const numTimes = 48;
            const times = [];
            const now = new Date();
            
            for (let t = 0; t < numTimes; t++) {
                times.push(new Date(now.getTime() + t * 3600000));
            }
            
            const temperature = [];
            const dewpoint = [];
            const windSpeed = [];
            const windGust = [];
            const precipitation = [];
            const humidity = [];
            
            for (let t = 0; t < numTimes; t++) {
                const hour = (now.getHours() + t) % 24;
                const dayPhase = Math.sin((hour - 6) * Math.PI / 12);
                const temp = 50 + 25 * dayPhase + (Math.random() - 0.5) * 5;
                temperature.push(temp);
                
                const rh = Math.max(10, Math.min(95, 40 + 30 * Math.sin(t * Math.PI / 24)));
                humidity.push(rh);
                dewpoint.push(temp - ((100 - rh) / 5));
                
                const wind = Math.max(0, 10 + 5 * Math.sin(t * Math.PI / 12) + (Math.random() - 0.5) * 5);
                windSpeed.push(wind);
                windGust.push(wind * (1.3 + Math.random() * 0.2));
                
                precipitation.push(Math.max(0, Math.sin(t * Math.PI / 24) * 0.1));
            }
            
            createMeteograms(times, temperature, dewpoint, windSpeed, windGust, precipitation, humidity);
            document.getElementById('meteogramSection').style.display = 'block';
        }

        function createMeteograms(times, temp, dew, wind, gust, precip, humid) {
            // Temperature plot
            Plotly.newPlot('tempPlot', [
                {
                    x: times, y: temp, name: 'Temperature', type: 'scatter', mode: 'lines+markers',
                    line: { color: '#dc2626', width: 2 }, marker: { size: 4 }
                },
                {
                    x: times, y: dew, name: 'Dewpoint', type: 'scatter', mode: 'lines+markers',
                    line: { color: '#2563eb', width: 2 }, marker: { size: 4 }
                }
            ], {
                margin: { l: 50, r: 20, t: 30, b: 40 },
                title: 'Temperature & Dewpoint (°F)',
                hovermode: 'x unified',
                plot_bgcolor: '#fafafa'
            }, { responsive: true });
            
            // Wind plot
            Plotly.newPlot('windPlot', [
                {
                    x: times, y: wind, name: 'Wind Speed', type: 'scatter', mode: 'lines+markers',
                    line: { color: '#059669', width: 2 }, marker: { size: 4 }
                },
                {
                    x: times, y: gust, name: 'Gust', type: 'scatter', mode: 'lines',
                    line: { color: '#ea580c', width: 1, dash: 'dash' }
                }
            ], {
                margin: { l: 50, r: 20, t: 30, b: 40 },
                title: 'Wind Speed & Gusts (mph)',
                hovermode: 'x unified',
                plot_bgcolor: '#fafafa'
            }, { responsive: true });
            
            // Precip/humidity plot
            Plotly.newPlot('precipPlot', [
                {
                    x: times, y: precip, name: 'Precipitation', type: 'bar',
                    marker: { color: '#0284c7' }
                },
                {
                    x: times, y: humid, name: 'Humidity', type: 'scatter', mode: 'lines',
                    line: { color: '#65a30d', width: 2 }, yaxis: 'y2'
                }
            ], {
                margin: { l: 50, r: 50, t: 30, b: 40 },
                title: 'Precipitation (in/hr) & Humidity (%)',
                yaxis: { title: 'Precipitation' },
                yaxis2: { title: 'Humidity (%)', overlaying: 'y', side: 'right', range: [0, 100] },
                hovermode: 'x unified',
                plot_bgcolor: '#fafafa'
            }, { responsive: true });
        }

        // Initialize on load
        window.onload = function() {
            initMap();
            showStatus('Map initialized. Select layers from the control panel.', 'success');
        };
    </script>
</body>
</html>
